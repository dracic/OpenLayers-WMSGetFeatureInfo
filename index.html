<!DOCTYPE html>
<html>
  <head>
    <title>WMS getfeatureinfo</title>
    <meta http-equiv="Content-Type"
      content="text/html; charset=UTF-8">

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/proj4js/1.1.0/proj4js-compressed.min.js"></script>
    <script type="text/javascript" src="./js/OpenLayers-2.13.1/OpenLayers.js"></script>
    <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./js/OpenLayers-2.13.1/theme/default/style.css" type="text/css">

	<link rel="stylesheet" type="text/css" href="./css/cookbook.css">


  </head>
  <body>
  <!-- Map DOM element -->
	<div id="mapdiv" style="width: 80%; height: 60%;"></div>

  <!--Button for unselecting polygon-->
  <button onclick="unselect()">Unselect</button>
  <!--Button for changing value to processed-->
  <input name="myBtn" type="submit" value="Processed" onClick="ajax_post1()"></input>
  <!--Button for changing value to unprocessed-->
  <input name="myBtn2" type="submit" value="Not processed" onClick="ajax_post2()"></input>
  <!--Button for redrawing WMS layer with polygons (for debugging)-->
  <input name="myBtn3" type="submit" value="Redraw" onClick="redrawWMS()"></input>
  <br /><br />
  <div id="status"></div>

	<script type="text/javascript">
     //proxy
     OpenLayers.ProxyHost = "/php/OpenLayers-WMSGetFeatureInfo/utils/proxy.php?url=";

     //dots per inch definition
     OpenLayers.DOTS_PER_INCH = 90.71428571428572;

     //EPSG:3765 definition (proj4js)
     Proj4js.defs["EPSG:3765"] = "+proj=tmerc +lat_0=0 +lon_0=16.5 +k=0.9999 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";

     OpenLayers.Projection.defaults['EPSG:3765'] = {
       yx: false
     };

     //id of selected feature
     var featureId;

    // Create the map using the specified DOM element
    var map = new OpenLayers.Map("mapdiv");

    //blank vector layer for highlighting
    var highlight_style = { fillColor:'#99CCFF', strokeColor:'#3399FF', fillOpacity:0.7 };
    var hilites = new OpenLayers.Layer.Vector("Highlighted",
    {isBaseLayer:false, visibility:true, style:highlight_style}
    );

    // Add background WMS layer
    var wms = new OpenLayers.Layer.WMS("Basic", "http://vmap0.tiles.osgeo.org/wms/vmap0",
    {
        layers: 'basic'
    });

	  // Add tk25gridQC WMS layer
    var borders = new OpenLayers.Layer.WMS("Borders", "http://localhost:8080/geoserver/tk25gridQC/wms",
    {
        layers: "tk25gridQC:tk25_grid_qc",
		    transparent: true,
        format: 'image/png'
    },
    {singleTile: true, ratio: 1},
    {
       isBaseLayer: false
    });


    //add layers to map
    map.addLayers([wms, borders, hilites]);

    // Add layer switcher control
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    // Set the center of the view
    map.setCenter(new OpenLayers.LonLat(16,45), 6);

    //selection
    map.events.register('click', map, function (e) {
    var pixel = new OpenLayers.Pixel(e.xy.x,e.xy.y);
    var lonlat = map.getLonLatFromPixel(pixel);

    OpenLayers.Request.GET({
        url: "http://localhost:8080/geoserver/tk25gridQC/wms",
        params: {
            SERVICE: "WMS",
            VERSION: "1.1.1",
            REQUEST: "GetFeatureInfo",
            EXCEPTIONS: "application/vnd.ogc.se_xml",
            BBOX: map.getExtent().toBBOX(),
            X: e.xy.x,
            Y: e.xy.y,
            INFO_FORMAT: 'application/vnd.ogc.gml',
            QUERY_LAYERS: 'tk25gridQC:tk25_grid_qc',
            FEATURE_COUNT: 1,
            Layers: 'tk25gridQC:tk25_grid_qc',
            Styles: '',
            Srs: 'EPSG:4326',
            WIDTH: map.size.w,
            HEIGHT: map.size.h
        },
        success: highlight_them,
        failure: highlight_them
    });

    OpenLayers.Event.stop(e);
    });


    function highlight_them(request) {
        // use the GML parser to turn the XML into a list of Feature objects
        // have the Vector layer purge its feature list, replace them with the new ones
        //console.log(request.responseText)
        var features = new OpenLayers.Format.GML().read(request.responseText);
        //console.log(features);

        if (typeof features[0] !== 'undefined') {
          featureId = features[0].attributes.gid;
          console.log(featureId);
        } else {
          featureId = undefined;
        }


        //destroy existing feature (unselect) and draw a new one
        hilites.destroyFeatures();
        hilites.addFeatures(features);
        };

   //function called with "unselect" button
   function unselect(){
     hilites.destroyFeatures();
     featureId = undefined;
   };

   //AJAX requests that post data to php script
   //featureId is in $_POST array ($_POST['idd'])
   function ajax_post1() {
     if (typeof featureId !== 'undefined') {
       $.post('parse_file.php', {idd: featureId}).done(function(){
         redrawWMS();
       });
     }
   }

   function ajax_post2() {
     if (typeof featureId !== 'undefined') {
       $.post('parse_file2.php', {idd: featureId}).done(function(){
         redrawWMS();
       });
     }
   }

   //function for redrawing WMS layer
   function redrawWMS(){
     featureId = undefined;
     hilites.destroyFeatures();
     borders.redraw({force:true});
   };

    </script>
  </body>
</html>
